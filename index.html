<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFL Supercontest - 2025</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
        }

        .container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: #2d3748;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .game-card {
            background-color: #4a5568;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
        }

        .game-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .game-card.selected {
            border: 2px solid #63b3ed;
            background-color: #3e495a;
        }

        .game-card.past-game {
            background-color: #4a5568;
            opacity: 0.5;
            cursor: not-allowed;
        }

        .team-logo {
            width: 40px;
            height: 40px;
            object-fit: contain;
        }
        
        .pick-button {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .pick-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 6px 8px rgba(0, 0, 0, 0.2);
        }
        
        .pick-button:disabled {
            cursor: not-allowed;
            opacity: 0.6;
            transform: none;
            box-shadow: none;
        }

        /* Confirmation Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: #2d3748;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 500px;
            text-align: center;
        }
    </style>
</head>

<body class="bg-gray-900 text-gray-100">

    <div class="container">
        <div class="flex items-center justify-between mb-6">
            <h1 class="text-3xl font-bold text-center text-teal-300">NFL Supercontest - 2025</h1>
            <div id="loadingIndicator" class="hidden">
                <i class="fas fa-spinner fa-spin text-xl text-blue-400"></i>
            </div>
        </div>

        <p class="mb-4 text-gray-400">Hello there! Welcome to the NFL Pick 'em app. Please select the winners for exactly 5 games below. You must submit your picks before the deadline: <span class="font-bold text-red-400">6 PM CST Saturday</span>.</p>
        
        <div id="messageBox" class="p-4 mb-4 rounded-lg text-sm hidden"></div>

        <div id="pickDisplay" class="mb-4 hidden">
            <h2 class="text-xl font-bold mb-2">Your Submitted Picks</h2>
            <ul id="submittedPicksList" class="space-y-2"></ul>
        </div>

        <form id="picksForm" class="space-y-4">
            <div id="gamesList" class="space-y-4">
                <p class="text-center text-gray-400">Loading games...</p>
            </div>

            <div class="flex items-end justify-end space-x-4 mt-8">
                <div class="flex-grow max-w-xs">
                    <label for="username" class="block text-sm font-medium text-gray-300 mb-1">Your Username</label>
                    <select id="username" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" required>
                        <option value="">Loading usernames...</option>
                    </select>
                </div>
                <button type="submit" id="submitButton" class="pick-button px-8 py-4 rounded-full bg-blue-600 text-white font-bold text-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <i class="fas fa-paper-plane mr-2"></i> Submit Picks
                </button>
            </div>
        </form>

    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4">Confirm Your Picks</h2>
            <p class="mb-2 text-gray-300">Username: <span id="confirmUsername" class="font-bold"></span></p>
            <ul id="confirmPicksList" class="text-left space-y-2 mb-6"></ul>
            <div class="flex justify-center space-x-4">
                <button id="cancelButton" class="px-6 py-3 rounded-full bg-gray-600 text-white font-bold hover:bg-gray-700">Cancel</button>
                <button id="confirmButton" class="px-6 py-3 rounded-full bg-green-600 text-white font-bold hover:bg-green-700">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        // Placeholder for your Google Apps Script Web App URL
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxOoR163FHKkj--YCi61aEtId7k6QFCDwod5fUWsnyd4LXVRIuVJpBeTKxE3uPRLXDKlw/exec';
        // URL for the list of usernames
        const USERNAMES_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRZFTu66OZrQ5aQCMdFKSVeeMysGJZFgF60WFWYCB04rbzbgEcCAghEej2Xu3VBUNIEGOVhGNoTQROM/pub?gid=0&single=true&output=csv';
        // This URL should point to a Google Sheet containing the weekly submissions
        // You would need to create a public, read-only URL for the sheet that your Apps Script writes to.
        const SUBMISSIONS_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTDvan0KHZpX7RT7ZTPOBZDvBweF8V82caTcqTIPDuEnhJNmLFVL8QON6IZJCaBepJY1EjL1zBYYsuf/pub?gid=0&single=true&output=csv';


        let games = []; // Global variable to store fetched game data
        let selectedPicks = [];

        // Message box for user feedback
        const messageBox = document.getElementById('messageBox');
        function showMessage(message, type = 'info') {
            messageBox.textContent = message;
            messageBox.className = `p-4 mb-4 rounded-lg text-sm block`;
            if (type === 'success') {
                messageBox.classList.add('bg-green-600', 'text-white');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-600', 'text-white');
            } else {
                messageBox.classList.add('bg-blue-600', 'text-white');
            }
        }

        // Function to fetch and parse the CSV data for games
        async function fetchGameData() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            loadingIndicator.classList.remove('hidden');
            try {
                const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vTDvan0KHZpX7RT7ZTPOBZDvBweF8V82caTcqTIPDuEnhJNmLFVL8QON6IZJCaBepJY1EjL1zBYYsuf/pub?output=csv');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const csvText = await response.text();
                games = parseCSV(csvText);
                return games;
            } catch (error) {
                console.error('Error fetching game data:', error);
                showMessage('Failed to load game data. Please try again later.', 'error');
                return null;
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        // Function to fetch and parse the CSV data for usernames
        async function fetchUsernames() {
            try {
                const response = await fetch(USERNAMES_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const csvText = await response.text();
                // Assumes the CSV is a single column of usernames
                const usernames = csvText.trim().split('\n').filter(name => name.trim() !== '');
                return usernames;
            } catch (error) {
                console.error('Error fetching usernames:', error);
                showMessage('Failed to load usernames. Please try refreshing the page.', 'error');
                return [];
            }
        }

        // Function to fetch and check for an existing submission for the selected user
        async function checkExistingSubmission(username) {
            try {
                const response = await fetch(SUBMISSIONS_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const csvText = await response.text();
                const submissions = csvText.trim().split('\n').map(line => line.split(',')[0].trim());
                return submissions.includes(username);
            } catch (error) {
                console.error('Error checking for duplicate submission:', error);
                // Return false to allow submission in case the check fails
                return false;
            }
        }

        // Function to populate the username dropdown
        function populateUsernames(usernames) {
            const usernameSelect = document.getElementById('username');
            usernameSelect.innerHTML = '<option value="">Select a username</option>'; // Default empty option
            usernames.forEach(username => {
                const option = document.createElement('option');
                option.value = username;
                option.textContent = username;
                usernameSelect.appendChild(option);
            });
        }

        // Function to parse CSV text into an array of game objects
        function parseCSV(csv) {
            const lines = csv.trim().split('\n');
            const data = [];
            const headers = lines[0].split(',').map(header => header.trim());
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(value => value.trim());
                if (values.length === headers.length) {
                    const game = {
                        id: (i).toString(),
                        date: values[0],
                        time: values[1],
                        away: values[2],
                        home: values[3],
                        line: values[4],
                        timezone: 'CST'
                    };
                    data.push(game);
                }
            }
            return data;
        }

        // Function to render the game list and set up event listeners
        function renderGames(gamesList) {
            gamesList.innerHTML = '';
            
            if (games.length === 0) {
                gamesList.innerHTML = '<p class="text-center text-red-400">No game data available.</p>';
                return;
            }

            games.forEach(game => {
                const gameDate = new Date(`${game.date} ${game.time} CST`);
                const now = new Date();
                const isPastGame = now > gameDate;
                
                const gameCard = document.createElement('div');
                gameCard.className = `game-card flex flex-col sm:flex-row items-center justify-between transition-all duration-300 ${isPastGame ? 'past-game' : ''}`;
                gameCard.id = `game-${game.id}`;

                gameCard.innerHTML = `
                    <div class="flex items-center w-full sm:w-1/3">
                        <div class="w-16 h-16 sm:w-12 sm:h-12 flex-shrink-0 flex items-center justify-center rounded-full bg-gray-600 mr-4">
                           <i class="fas fa-football-ball text-2xl text-white"></i>
                        </div>
                        <div class="flex flex-col text-center sm:text-left">
                            <span class="text-xl font-bold text-gray-200">${game.away} vs ${game.home}</span>
                            <span class="text-sm text-gray-400">${game.date} - ${game.time} ${game.timezone}</span>
                        </div>
                    </div>

                    <div class="mt-4 sm:mt-0 w-full sm:w-1/3 text-center">
                        <span class="text-lg font-bold text-purple-300">Line: ${game.line}</span>
                    </div>

                    <div class="flex-grow flex justify-center sm:justify-end mt-4 sm:mt-0 space-x-2">
                        <button type="button" data-game-id="${game.id}" data-team-pick="${game.away}" class="pick-button flex-1 py-2 px-4 rounded-full text-sm font-medium bg-gray-700 hover:bg-gray-600 ${isPastGame ? 'disabled' : ''}" ${isPastGame ? 'disabled' : ''}>
                            <i class="fas fa-check-circle mr-1"></i> Pick ${game.away}
                        </button>
                        <button type="button" data-game-id="${game.id}" data-team-pick="${game.home}" class="pick-button flex-1 py-2 px-4 rounded-full text-sm font-medium bg-gray-700 hover:bg-gray-600 ${isPastGame ? 'disabled' : ''}" ${isPastGame ? 'disabled' : ''}>
                            <i class="fas fa-check-circle mr-1"></i> Pick ${game.home}
                        </button>
                    </div>
                `;
                gamesList.appendChild(gameCard);

                // Add event listener to each button if the game is not in the past
                if (!isPastGame) {
                    gameCard.querySelectorAll('button').forEach(button => {
                        button.addEventListener('click', () => handlePick(game.id, button.dataset.team-pick));
                    });
                }
            });
            updateUI();
        }

        function handlePick(gameId, teamPick) {
            // Unselect if already selected
            const existingPickIndex = selectedPicks.findIndex(p => p.gameId === gameId);
            if (existingPickIndex !== -1) {
                if (selectedPicks[existingPickIndex].pick === teamPick) {
                    selectedPicks.splice(existingPickIndex, 1); // Unselect this pick
                } else {
                    selectedPicks[existingPickIndex].pick = teamPick; // Change pick for this game
                }
            } else {
                // Check if the 5-game limit is reached
                if (selectedPicks.length >= 5) {
                    showMessage('You can only select exactly 5 games.', 'error');
                    return;
                }
                selectedPicks.push({ gameId, pick: teamPick });
            }

            // Update UI to reflect selected games
            updateUI();
        }

        function updateUI() {
            document.querySelectorAll('.game-card').forEach(card => card.classList.remove('selected'));
            document.querySelectorAll('.pick-button').forEach(button => {
                button.classList.remove('bg-green-600');
                button.classList.add('bg-gray-700', 'hover:bg-gray-600');
            });
            selectedPicks.forEach(pick => {
                const card = document.getElementById(`game-${pick.gameId}`);
                card.classList.add('selected');
                const button = card.querySelector(`[data-team-pick="${pick.pick}"]`);
                if (button) {
                    button.classList.remove('bg-gray-700', 'hover:bg-gray-600');
                    button.classList.add('bg-green-600');
                }
            });
            showMessage(`${selectedPicks.length} of 5 games selected.`);
        }

        function showConfirmationModal() {
            const username = document.getElementById('username').value;
            const confirmUsername = document.getElementById('confirmUsername');
            const confirmPicksList = document.getElementById('confirmPicksList');
            const confirmationModal = document.getElementById('confirmationModal');
            
            confirmUsername.textContent = username;
            confirmPicksList.innerHTML = '';
            
            selectedPicks.forEach(pick => {
                const game = games.find(g => g.id === pick.gameId);
                const listItem = document.createElement('li');
                listItem.textContent = `${game.away} vs ${game.home}: Picked ${pick.pick}`;
                confirmPicksList.appendChild(listItem);
            });
            
            confirmationModal.classList.remove('hidden');
        }

        function hideConfirmationModal() {
            const confirmationModal = document.getElementById('confirmationModal');
            confirmationModal.classList.add('hidden');
        }

        async function submitPicks() {
            const username = document.getElementById('username').value;
            const submitButton = document.getElementById('submitButton');

            hideConfirmationModal();
            submitButton.disabled = true;
            document.getElementById('loadingIndicator').classList.remove('hidden');

            try {
                // Prepare data for the Google Apps Script
                const payload = {
                    username: username,
                    picks: selectedPicks,
                    timestamp: new Date().toISOString()
                };

                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Required for Google Apps Script
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                });
                
                showMessage('Picks submitted successfully! Please refresh the page to see your submitted picks.', 'success');
                document.getElementById('picksForm').reset();
                selectedPicks = [];
                updateUI();
                
            } catch (e) {
                console.error("Error submitting picks: ", e);
                showMessage('Failed to submit picks. Please try again.', 'error');
            } finally {
                submitButton.disabled = false;
                document.getElementById('loadingIndicator').classList.add('hidden');
            }
        }

        const gamesList = document.getElementById('gamesList');
        
        // Initial setup
        async function init() {
            games = await fetchGameData();
            if (games) {
                renderGames(gamesList);
            }
            const usernames = await fetchUsernames();
            if (usernames.length > 0) {
                populateUsernames(usernames);
            }
        }
        
        // Handle form submission
        document.getElementById('picksForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            if (!username) {
                showMessage('Please enter a username.', 'error');
                return;
            }

            if (selectedPicks.length !== 5) {
                showMessage('You must select exactly 5 games.', 'error');
                return;
            }

            const now = new Date();
            const deadline = new Date();
            deadline.setFullYear(now.getFullYear(), now.getMonth(), now.getDate());
            deadline.setHours(18, 0, 0, 0); // 6 PM CST
            // Adjust for the current day of the week to get to Saturday
            const dayOfWeek = deadline.getDay(); // Sunday is 0, Saturday is 6
            if (dayOfWeek < 6) {
                deadline.setDate(deadline.getDate() + (6 - dayOfWeek));
            } else if (dayOfWeek === 0) { // If it's Sunday, go back to last Saturday
                deadline.setDate(deadline.getDate() - 1);
            }
            // Check if current date and time is past the Saturday 6 PM CST deadline
            if (now > deadline) {
                showMessage('The weekly deadline for submitting picks has passed.', 'error');
                return;
            }

            // Check if any selected games are in the past
            for (const pick of selectedPicks) {
                const game = games.find(g => g.id === pick.gameId);
                const gameDate = new Date(`${game.date} ${game.time} CST`);
                if (now > gameDate) {
                    showMessage(`You cannot select a game that has already started: ${game.away} vs ${game.home}`, 'error');
                    return;
                }
            }
            
            // Check if user has already submitted
            const isDuplicate = await checkExistingSubmission(username);
            if (isDuplicate) {
                showMessage('You have already submitted your picks for this week.', 'error');
                return;
            }

            // Show the confirmation modal
            showConfirmationModal();
        });

        // Add event listeners for the confirmation buttons
        document.getElementById('confirmButton').addEventListener('click', submitPicks);
        document.getElementById('cancelButton').addEventListener('click', hideConfirmationModal);

        window.onload = init;
    </script>

</body>
</html>
